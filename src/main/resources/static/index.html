<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>üåº Kindergarten Admin Panel</title>
  <style>
    /* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫—Ä–∞—Å–∏–≤—ã–π –¥–∏–∑–∞–π–Ω */
    :root{
      --bg:#0f1724; --surface:#0b1220; --muted:#9aa4b2; --accent:#7c3aed; 
      --glass: rgba(255,255,255,0.03); --card-bg: #0b1220; --card-2: #071733; 
      --success: #16a34a; --danger:#ef4444; --warning:#f59e0b;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box; margin:0; padding:0}
    html,body{height:100%;background:linear-gradient(180deg,#071127 0%, #071733 60%);color:#e6eef8}
    .wrap{max-width:1400px;margin:20px auto;padding:24px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 8px 30px rgba(2,6,23,0.7)}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.05)}
      header h1{margin:0;font-size:24px;font-weight:600;background:linear-gradient(135deg, #7c3aed, #a855f7);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;color:transparent}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .token{padding:10px 14px;border-radius:10px;background:rgba(255,255,255,0.05);font-size:13px;border:1px solid rgba(255,255,255,0.1)}
    .token.success{background:rgba(22,163,74,0.1);border-color:var(--success);color:var(--success)}
    input[type="text"]{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);padding:10px 14px;border-radius:10px;color:inherit;font-size:14px;min-width:200px}
    input[type="text"]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,0.1)}
    .btn{background:var(--accent);border:none;padding:10px 20px;border-radius:10px;color:white;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s}
    .btn:hover{background:#6d28d9;transform:translateY(-1px);box-shadow:0 4px 12px rgba(124,58,237,0.3)}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--muted)}
    .btn.ghost:hover{background:rgba(255,255,255,0.05);border-color:var(--accent);color:white}
    .btn.success{background:var(--success)}
    .btn.danger{background:var(--danger)}
    .layout{display:grid;grid-template-columns:280px 1fr;gap:24px;margin-top:24px}
    nav.card, section.card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.05)}
    nav .menu{display:flex;flex-direction:column;gap:8px}
    nav .menu button{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted);padding:12px 16px;border-radius:10px;text-align:left;cursor:pointer;font-size:14px;transition:all 0.2s}
    nav .menu button:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.1);color:white}
    nav .menu button.active{border-color:var(--accent);color:white;background:rgba(124,58,237,0.1);box-shadow:0 4px 20px rgba(124,58,237,0.15)}
    section.card{min-height:500px}
    .grid-two{display:grid;grid-template-columns:1fr 400px;gap:20px}
    form.row{display:flex;flex-wrap:wrap;gap:16px;margin-top:16px}
    label.field{display:flex;flex-direction:column;font-size:13px;color:var(--muted);gap:6px;min-width:200px}
    label.field span{font-weight:500}
    input, select, textarea{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);padding:10px 14px;border-radius:10px;color:inherit;font-size:14px;transition:all 0.2s}
    input:focus, select:focus, textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,0.1)}
    .actions{display:flex;gap:10px;align-items:center;margin-top:16px}
    table{width:100%;border-collapse:collapse;margin-top:16px;background:rgba(255,255,255,0.02);border-radius:10px;overflow:hidden}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px;text-align:left}
    th{background:rgba(255,255,255,0.05);font-weight:600;color:white}
    tr:hover{background:rgba(255,255,255,0.02)}
    .muted{color:var(--muted);font-size:13px}
    .notice{padding:12px;border-radius:10px;background:rgba(255,255,255,0.03);margin-bottom:12px;color:var(--muted);border-left:3px solid var(--accent)}
    .danger{background:rgba(239,68,68,0.1);border-left-color:var(--danger)}
    .success-notice{background:rgba(22,163,74,0.1);border-left-color:var(--success)}
    footer{margin-top:20px;color:var(--muted);font-size:12px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.05)}
    .small{font-size:12px;color:var(--muted)}
    .flex{display:flex;gap:10px;align-items:center}
    .right{margin-left:auto}
    .pill{padding:6px 12px;border-radius:20px;background:rgba(255,255,255,0.05);font-size:12px}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.8);z-index:1000;backdrop-filter:blur(4px)}
    .modal .box{background:var(--card-bg);padding:24px;border-radius:16px;width:600px;max-width:95%;border:1px solid rgba(255,255,255,0.1);box-shadow:0 20px 60px rgba(0,0,0,0.5)}
    .hidden{display:none!important}
    .toast{position:fixed;top:20px;right:20px;padding:16px 20px;border-radius:12px;background:var(--card-bg);border:1px solid rgba(255,255,255,0.1);box-shadow:0 8px 24px rgba(0,0,0,0.3);z-index:2000;min-width:300px;animation:slideIn 0.3s}
    .toast.success{border-left:4px solid var(--success)}
    .toast.error{border-left:4px solid var(--danger)}
    .toast.warning{border-left:4px solid var(--warning)}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    .loading{opacity:0.6;pointer-events:none;position:relative}
    .loading::after{content:'';position:absolute;top:50%;left:50%;width:20px;height:20px;margin:-10px 0 0 -10px;border:2px solid var(--accent);border-top-color:transparent;border-radius:50%;animation:spin 0.6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.05)}
    .section-header h2{margin:0;font-size:20px;font-weight:600}
    @media(max-width:1024px){.layout{grid-template-columns:1fr}.grid-two{grid-template-columns:1fr}}
    .code-display{padding:16px;background:rgba(124,58,237,0.15);border-radius:12px;border:2px solid var(--accent);margin-top:16px;text-align:center}
    .code-display .code{font-size:32px;font-weight:bold;color:var(--accent);letter-spacing:8px;margin:12px 0;font-family:'Courier New',monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üåº Kindergarten Admin Panel</h1>
        <div class="small muted" style="margin-top:8px">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç—Å–∫–∏–º —Å–∞–¥–æ–º ‚Ä¢ –£–∫–∞–∂–∏—Ç–µ API Base URL</div>
      </div>
      <div class="controls">
        <input id="apiBase" type="text" placeholder="http://localhost:8080" value="http://localhost:8080" style="min-width:250px"/>
        <button class="btn ghost" id="testConnectionBtn" style="white-space:nowrap">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
        <div class="token" id="userInfo">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
        <button class="btn ghost" id="btnShowAuth">üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</button>
      </div>
    </header>

    <div class="layout">
      <nav class="card">
        <div style="margin-bottom:16px;font-weight:600;color:white">–ú–µ–Ω—é</div>
        <div class="menu" id="menu">
          <button data-key="auth" class="active">üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</button>
          <button data-key="age-group">üë∂ –í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã</button>
          <button data-key="group">üë• –ì—Ä—É–ø–ø—ã</button>
          <button data-key="child">üßí –î–µ—Ç–∏</button>
          <button data-key="parent">üë®‚Äçüë©‚Äçüëß –†–æ–¥–∏—Ç–µ–ª–∏</button>
          <button data-key="teacher">üë©‚Äçüè´ –í–æ—Å–ø–∏—Ç–∞—Ç–µ–ª–∏</button>
          <button data-key="payment">üí∞ –ü–ª–∞—Ç–µ–∂–∏</button>
          <button data-key="child-group-history">üìã –ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–ø–ø</button>
        </div>
      </nav>

      <main>
        <section class="card" id="panel">
          <div class="section-header">
            <div>
              <h2 id="panelTitle">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
              <div class="small muted" style="margin-top:4px" id="panelHint">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º</div>
            </div>
          </div>

          <div id="panelContent" style="margin-top:20px">
            <!-- Dynamic content -->
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal hidden">
    <div class="box">
      <h3 id="modalTitle" style="margin-bottom:20px">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
      <div id="modalBody"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px">
        <button class="btn ghost" id="modalCancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn" id="modalSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
  /*******************************
   * Helper utils
   *******************************/
  const $ = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

  function apiUrl(path){
    const base = (document.getElementById('apiBase').value || '').replace(/\/$/, '');
    if(!base) {
      showToast('–£–∫–∞–∂–∏—Ç–µ API Base URL', 'warning');
      return null;
    }
    if(!path.startsWith('/')) path = '/' + path;
    return base + path;
  }

  function authHeader(){
    const t = localStorage.getItem('kg_token');
    return t ? { 'Authorization': 'Bearer ' + t } : {};
  }

  async function fetchJson(url, opts = {}){
    if(!url) {
      throw { message: 'URL –Ω–µ —É–∫–∞–∑–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ API Base URL.', status: 0 };
    }
    
    try {
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
      const headers = { 
        'Accept': 'application/json',
        ...authHeader()
      };
      
      // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
      if(opts.headers) {
        Object.assign(headers, opts.headers);
      }
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ JSON
      if(opts.body && typeof opts.body === 'object' && !(opts.body instanceof FormData)) {
        headers['Content-Type'] = 'application/json';
        opts.body = JSON.stringify(opts.body);
      }
      
      opts.headers = headers;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000);
      opts.signal = controller.signal;
      opts.mode = 'cors';
      opts.cache = 'no-cache';
      
      const res = await fetch(url, opts);
      clearTimeout(timeoutId);
      
      // –ß–∏—Ç–∞–µ–º –æ—Ç–≤–µ—Ç
      const text = await res.text().catch(()=>'');
      let data = null;
      try{ 
        data = text ? JSON.parse(text) : null;
      }catch(e){ 
        // –ï—Å–ª–∏ –Ω–µ JSON, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç
        data = text || null;
      }
      
      if(!res.ok) {
        const errorMsg = data?.message || data?.error || `HTTP ${res.status}: ${res.statusText}`;
        const error = { 
          status: res.status, 
          data, 
          message: errorMsg 
        };
        throw error;
      }
      
      return data;
    } catch (error) {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
      if(error.name === 'AbortError') {
        throw { 
          message: '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (30 —Å–µ–∫). –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.', 
          status: 0 
        };
      }
      
      // –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
      if(error.message && (
        error.message.includes('Failed to fetch') || 
        error.message.includes('NetworkError') ||
        error.message.includes('Network request failed') ||
        error.message.includes('Load failed')
      )) {
        const baseUrl = document.getElementById('apiBase')?.value || '–Ω–µ —É–∫–∞–∑–∞–Ω';
        throw { 
          message: `–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É.\n\nURL: ${baseUrl}\n\n–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n‚Ä¢ –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω\n‚Ä¢ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL\n‚Ä¢ –ü–æ—Ä—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π—Ä–≤–æ–ª–æ–º\n‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å CORS\n\n–†–µ—à–µ–Ω–∏–µ: –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"`, 
          status: 0 
        };
      }
      
      // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏
      throw error;
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
  async function checkServerConnection(silent = false) {
    const baseUrl = document.getElementById('apiBase')?.value;
    if(!baseUrl || !baseUrl.trim()) {
      if(!silent) showToast('–£–∫–∞–∂–∏—Ç–µ API Base URL', 'warning');
      return false;
    }
    
    try {
      // –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –∫ health endpoint
      const url = baseUrl.replace(/\/$/, '') + '/api/health';
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 3000);
      
      const response = await fetch(url, {
        method: 'GET',
        headers: { 'Accept': 'application/json' },
        signal: controller.signal,
        mode: 'cors',
        cache: 'no-cache'
      });
      
      clearTimeout(timeoutId);
      
      if(response.ok) {
        try {
          const data = await response.json();
          return data.status === 'UP';
        } catch(e) {
          // –ï—Å–ª–∏ –Ω–µ JSON, –Ω–æ –æ—Ç–≤–µ—Ç 200 - —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
          return true;
        }
      }
      return false;
    } catch (error) {
      if(!silent) {
        console.error('Connection check error:', error);
      }
      return false;
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–¥–ª—è –∫–Ω–æ–ø–∫–∏)
  async function testConnection() {
    const btn = $('#testConnectionBtn');
    if(btn) {
      btn.disabled = true;
      btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
    }
    
    const connected = await checkServerConnection(false);
    
    if(btn) {
      btn.disabled = false;
      btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ';
    }
    
    if(connected) {
      showToast('‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω!', 'success');
    } else {
      const baseUrl = document.getElementById('apiBase')?.value || '–Ω–µ —É–∫–∞–∑–∞–Ω';
      showToast(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ ${baseUrl}\n\n–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:\n‚Ä¢ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (mvn spring-boot:run)\n‚Ä¢ URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π\n‚Ä¢ –ü–æ—Ä—Ç –Ω–µ –∑–∞–Ω—è—Ç`, 'error');
    }
    
    return connected;
  }

  function showUserInfo(){
    const el = $('#userInfo');
    const t = localStorage.getItem('kg_token');
    if(t) {
      el.textContent = '‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
      el.classList.add('success');
    } else {
      el.textContent = '‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
      el.classList.remove('success');
    }
  }

  function showToast(message, type = 'success'){
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<div style="font-weight:500;margin-bottom:4px">${type === 'error' ? '‚ùå –û—à–∏–±–∫–∞' : type === 'warning' ? '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ' : '‚úÖ –£—Å–ø–µ—Ö'}</div><div style="font-size:13px;color:var(--muted)">${message}</div>`;
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.style.animation = 'slideIn 0.3s reverse';
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  /*******************************
   * UI templates for entities
   *******************************/
  const entitySchemas = {
    'auth': { name: '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è' },
    'age-group': {
      name: '–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã',
      path: '/api/age-group',
      createFields: [
        {k:'name', label:'–ù–∞–∑–≤–∞–Ω–∏–µ', type:'text', required:true},
        {k:'ageGroup', label:'–í–æ–∑—Ä–∞—Å—Ç (1-7)', type:'number', min:1, max:7, required:true},
        {k:'price', label:'–¶–µ–Ω–∞', type:'number', step:'0.01', required:true}
      ],
      hasStatus:false
    },
    'group': {
      name:'–ì—Ä—É–ø–ø—ã',
      path:'/api/group',
      createFields:[
        {k:'name',label:'–ù–∞–∑–≤–∞–Ω–∏–µ',type:'text',required:true},
        {k:'ageGroupId',label:'AgeGroup ID',type:'number',required:true}
      ],
      special:{
        addTeacherAssistantChild: apiUrl.bind(null, '/api/group/add-teacher-assistant-child')
      }
    },
    'child': {
      name:'–î–µ—Ç–∏',
      path:'/api/child',
      createFields:[
        {k:'firstName',label:'–ò–º—è',type:'text',required:true},
        {k:'lastName',label:'–§–∞–º–∏–ª–∏—è',type:'text',required:true},
        {k:'patronymic',label:'–û—Ç—á–µ—Å—Ç–≤–æ',type:'text'},
        {k:'dateOfBirth',label:'–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è',type:'date',required:true},
        {k:'group',label:'Group ID',type:'number'},
        {k:'parentsId',label:'Parents IDs (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)',type:'text'}
      ]
    },
    'parent': {
      name:'–†–æ–¥–∏—Ç–µ–ª–∏',
      path:'/api/parent',
      createFields:[
        {k:'firstName',label:'–ò–º—è',type:'text',required:true},
        {k:'lastName',label:'–§–∞–º–∏–ª–∏—è',type:'text',required:true},
        {k:'patronymic',label:'–û—Ç—á–µ—Å—Ç–≤–æ',type:'text'},
        {k:'contact.phoneNumber',label:'–¢–µ–ª–µ—Ñ–æ–Ω (+996XXXXXXXXX)',type:'text',required:true},
        {k:'contact.secondaryPhoneNumber',label:'–î–æ–ø. —Ç–µ–ª–µ—Ñ–æ–Ω',type:'text'},
        {k:'contact.email',label:'Email',type:'email',required:true}
      ],
      hasStatus:true,
      statusName:'role',
      statusOptions:['FATHER','MOTHER','OTHER','PARENT','ADMIN','TEACHER']
    },
    'teacher': {
      name:'–í–æ—Å–ø–∏—Ç–∞—Ç–µ–ª–∏',
      path:'/api/teacher',
      createFields:[
        {k:'firstName',label:'–ò–º—è',type:'text',required:true},
        {k:'lastName',label:'–§–∞–º–∏–ª–∏—è',type:'text',required:true},
        {k:'patronymic',label:'–û—Ç—á–µ—Å—Ç–≤–æ',type:'text'},
        {k:'dateOfBirth',label:'–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è',type:'date',required:true},
        {k:'contact.phoneNumber',label:'–¢–µ–ª–µ—Ñ–æ–Ω (+996XXXXXXXXX)',type:'text',required:true},
        {k:'contact.secondaryPhoneNumber',label:'–î–æ–ø. —Ç–µ–ª–µ—Ñ–æ–Ω',type:'text'},
        {k:'contact.email',label:'Email',type:'email',required:true}
      ],
      hasStatus:true,
      statusName:'position',
      statusOptions:['TEACHER','ASSISTANT','OTHER']
    },
    'payment': {
      name:'–ü–ª–∞—Ç–µ–∂–∏',
      path:'/api/payment',
      createFields:[
        {k:'childId',label:'Child ID',type:'number',required:true},
        {k:'paymentSum',label:'–°—É–º–º–∞',type:'number',step:'0.01',required:true},
        {k:'period',label:'–ü–µ—Ä–∏–æ–¥ MM.yyyy',type:'text',required:true}
      ],
      hasStatus:true,
      statusName:'paymentType',
      statusOptions:['MONTHLY','ONE_TIME']
    },
    'child-group-history': {
      name:'–ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–ø–ø',
      path:'/api/child-group-history',
      createFields:[
        {k:'groupId',label:'Group ID',type:'number',required:true},
        {k:'childId',label:'Child ID',type:'number',required:true}
      ]
    }
  };

  /*******************************
   * Render panel content for entity
   *******************************/
  const panelContent = $('#panelContent');
  const panelTitle = $('#panelTitle');

  async function renderEntity(key){
    panelContent.innerHTML = '';
    panelTitle.textContent = entitySchemas[key].name || key;
    $('#panelHint').textContent = '';

    if(key === 'auth'){ renderAuth(); return; }

    const s = entitySchemas[key];
    const card = document.createElement('div');
    card.className = 'grid-two';

    // LEFT: create form + list
    const left = document.createElement('div');
    left.innerHTML = `<div class="notice muted small">üì° Endpoint: <code>${s.path}</code></div>`;
    
    const createBox = document.createElement('div');
    createBox.className = 'card';
    createBox.style.marginBottom = '20px';
    createBox.innerHTML = '<h3 style="margin-bottom:16px;font-size:16px">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å</h3>';
    const f = document.createElement('form');
    f.className = 'row';
    f.id = key + '-create-form';

    s.createFields.forEach(fd=>{
      const label = document.createElement('label'); 
      label.className='field';
      label.innerHTML = `<span>${fd.label}${fd.required? ' <span style="color:var(--danger)">*</span>':''}</span>`;
      const input = document.createElement('input');
      input.name = fd.k;
      input.type = fd.type || 'text';
      if(fd.min !== undefined) input.min = fd.min;
      if(fd.max !== undefined) input.max = fd.max;
      if(fd.step) input.step = fd.step;
      if(fd.required) input.required = true;
      if(fd.type === 'email') input.placeholder = 'example@email.com';
      label.appendChild(input);
      f.appendChild(label);
    });
    
    if(s.hasStatus){
      const label = document.createElement('label'); 
      label.className='field';
      label.innerHTML = `<span>–°—Ç–∞—Ç—É—Å</span>`;
      const sel = document.createElement('select'); 
      sel.name = 'status';
      s.statusOptions.forEach(o=>{ 
        const op=document.createElement('option'); 
        op.value=o; 
        op.textContent=o; 
        sel.appendChild(op); 
      });
      label.appendChild(sel);
      f.appendChild(label);
    }
    
    const submit = document.createElement('button'); 
    submit.className='btn'; 
    submit.type = 'submit';
    submit.textContent='‚ûï –°–æ–∑–¥–∞—Ç—å';
    f.appendChild(submit);
    createBox.appendChild(f);
    left.appendChild(createBox);

    // list + controls
    const listBox = document.createElement('div'); 
    listBox.className='card';
    listBox.innerHTML = '<h3 style="margin-bottom:16px;font-size:16px">üìã –°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π</h3>';
    const controlRow = document.createElement('div'); 
    controlRow.className='flex';
    controlRow.style.marginBottom = '16px';
    controlRow.innerHTML = `
      <input id="${key}-query-id" placeholder="ID –¥–ª—è –ø–æ–∏—Å–∫–∞" style="flex:1;max-width:200px"/>
      <button id="${key}-find" class="btn ghost">üîç –ù–∞–π—Ç–∏</button>
      <div style="margin-left:auto" class="flex">
        <input id="${key}-page" type="number" value="0" style="width:80px" placeholder="–°—Ç—Ä."/>
        <input id="${key}-size" type="number" value="20" style="width:80px" placeholder="–†–∞–∑–º–µ—Ä"/>
        <button id="${key}-list" class="btn">üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>`;
    listBox.appendChild(controlRow);
    const tableWrap = document.createElement('div'); 
    tableWrap.id = key + '-table';
    listBox.appendChild(tableWrap);
    left.appendChild(listBox);

    // RIGHT: helper / docs
    const right = document.createElement('div');
    right.className = 'card';
    right.innerHTML = `
      <h3 style="margin-bottom:16px;font-size:16px">üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h3>
      <div class="muted small" style="line-height:1.8">
        <div style="margin-bottom:12px"><strong>Create</strong> ‚Äî POST ${s.path}/create${s.hasStatus? '?status=...':''}</div>
        <div style="margin-bottom:12px"><strong>Update</strong> ‚Äî PUT ${s.path}/update?id=&${s.hasStatus? 'status=&':''}delete=EXIST|DELETED</div>
        <div style="margin-bottom:12px"><strong>Delete</strong> ‚Äî DELETE ${s.path}/delete?id=</div>
        <div style="margin-bottom:12px"><strong>List</strong> ‚Äî GET ${s.path}/get-list?page=&size=</div>
        <div><strong>Find</strong> ‚Äî GET ${s.path}/find-by-id?id=</div>
      </div>
    `;
    
    if(key === 'group'){
      const h = document.createElement('div'); 
      h.style.marginTop='20px';
      h.innerHTML = `
        <div class="notice" style="margin-bottom:12px">–î–æ–±–∞–≤–∏—Ç—å —É—á–∏—Ç–µ–ª—è/–ø–æ–º–æ—â–Ω–∏–∫–∞/—Ä–µ–±—ë–Ω–∫–∞ –≤ –≥—Ä—É–ø–ø—É</div>
        <div class="row">
          <input id="grp-add-id" placeholder="ID –≥—Ä—É–ø–ø—ã" style="flex:1"/>
          <input id="grp-add-teach" placeholder="ID —É—á–∏—Ç–µ–ª—è (–æ–ø—Ü.)" style="flex:1"/>
          <input id="grp-add-child" placeholder="ID —Ä–µ–±—ë–Ω–∫–∞ (–æ–ø—Ü.)" style="flex:1"/>
          <button id="grp-add-btn" class="btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>`;
      right.appendChild(h);
    }

    card.appendChild(left);
    card.appendChild(right);
    panelContent.appendChild(card);

    // functions for list / find / create / edit / delete
    async function fetchList(){
      const page = $('#'+key+'-page').value || 0;
      const size = $('#'+key+'-size').value || 20;
      const btn = $('#'+key+'-list');
      btn.disabled = true;
      btn.classList.add('loading');
      try{
        const url = apiUrl((s.path || '/') + '/get-list?page=' + page + '&size=' + size);
        if(!url) return;
        const data = await fetchJson(url, { method:'GET' });
        renderTable(data);
        showToast(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${Array.isArray(data) ? data.length : 0}`);
      }catch(err){
        console.error(err);
        showToast(err.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
        $('#'+key+'-table').innerHTML = '<div class="notice danger">–û—à–∏–±–∫–∞: ' + (err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ') + '</div>';
      }finally{
        btn.disabled = false;
        btn.classList.remove('loading');
      }
    }

    async function findById(){
      const id = $('#'+key+'-query-id').value;
      if(!id){ showToast('–£–∫–∞–∂–∏—Ç–µ ID', 'warning'); return; }
      const btn = $('#'+key+'-find');
      btn.disabled = true;
      btn.classList.add('loading');
      try{
        const url = apiUrl((s.path || '/') + '/find-by-id?id=' + id);
        if(!url) return;
        const data = await fetchJson(url, { method:'GET' });
        renderTable([data]);
        showToast('–ó–∞–ø–∏—Å—å –Ω–∞–π–¥–µ–Ω–∞');
      }catch(err){ 
        console.error(err); 
        showToast(err.message || '–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
        $('#'+key+'-table').innerHTML = '<div class="notice danger">–û—à–∏–±–∫–∞: ' + (err.message || '–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞') + '</div>';
      }finally{
        btn.disabled = false;
        btn.classList.remove('loading');
      }
    }

    function renderTable(items){
      const wrap = $('#'+key+'-table');
      wrap.innerHTML = '';
      if(!items || items.length === 0){ 
        wrap.innerHTML = '<div class="notice muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'; 
        return; 
      }
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      const cols = new Set();
      items.forEach(it => Object.keys(it || {}).forEach(k => cols.add(k)));
      const colArr = Array.from(cols);
      colArr.forEach(c=>{ 
        const th = document.createElement('th'); 
        th.textContent = c; 
        headerRow.appendChild(th); 
      });
      headerRow.appendChild(document.createElement('th'));
      thead.appendChild(headerRow);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      items.forEach(item=>{
        const tr = document.createElement('tr');
        colArr.forEach(c=>{
          const td = document.createElement('td');
          let v = item[c];
          if(v === null || v === undefined) td.textContent = '';
          else if(typeof v === 'object') {
            try{ td.textContent = JSON.stringify(v).substring(0, 100); }catch(e){ td.textContent = String(v); }
          } else td.textContent = v;
          tr.appendChild(td);
        });
        const tdA = document.createElement('td');
        const btnEdit = document.createElement('button'); 
        btnEdit.className='btn ghost'; 
        btnEdit.textContent='‚úèÔ∏è';
        btnEdit.style.padding = '6px 12px';
        const btnDelete = document.createElement('button'); 
        btnDelete.className='btn ghost danger'; 
        btnDelete.textContent='üóëÔ∏è';
        btnDelete.style.padding = '6px 12px';
        btnEdit.addEventListener('click', ()=> openEdit(item));
        btnDelete.addEventListener('click', ()=> doDelete(item.id));
        tdA.appendChild(btnEdit); 
        tdA.appendChild(btnDelete);
        tr.appendChild(tdA);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      wrap.appendChild(table);
    }

    function buildCreateBody(formData){
      const body = {};
      for(const [k,v] of new FormData(formData).entries()){
        if(k === 'status') continue;
        if(k.includes('contact.')){
          const parts = k.split('.');
          body['contactCreate'] = body['contactCreate'] || {};
          body['contactCreate'][parts[1]] = v;
        } else if(k === 'parentsId'){
          const arr = v ? v.split(',').map(x=>{ const n = Number(x.trim()); return isNaN(n)? null : n; }).filter(x=>x!==null) : [];
          body['parentsId'] = arr;
        } else if(k === 'group' || k === 'groupId' || k === 'ageGroupId'){
          const num = Number(v); if(!isNaN(num)) body[k] = num; else body[k] = v;
        } else if(k === 'dateOfBirth'){
          body[k] = v;
        } else if(k === 'paymentDate'){
          body[k] = v;
        } else if(k === 'childId' || k==='paymentSum' || k==='ageGroup' || k==='price'){
          const num = Number(v); body[k] = isNaN(num) ? v : num;
        } else {
          body[k] = v;
        }
      }
      return body;
    }

    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.classList.add('loading');
      const status = f.querySelector('[name="status"]') ? f.querySelector('[name="status"]').value : null;
      const body = buildCreateBody(f);
      try{
        let url = apiUrl(s.path + '/create');
        if(!url) return;
        if(status) url += '?'+encodeURIComponent(s.statusName || 'status')+'='+encodeURIComponent(status);
        const data = await fetchJson(url, { method:'POST', body });
        showToast('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞! ID: ' + (data?.id || 'OK'));
        f.reset();
        fetchList();
      }catch(err){
        console.error(err);
        showToast(err.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏', 'error');
      }finally{
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
      }
    });

    $('#'+key+'-list').addEventListener('click', fetchList);
    $('#'+key+'-find').addEventListener('click', findById);
    $('#'+key+'-query-id').addEventListener('keypress', (e) => {
      if(e.key === 'Enter') findById();
    });

    if(key === 'group'){
      $('#grp-add-btn').addEventListener('click', async ()=>{
        const gid = $('#grp-add-id').value;
        const tid = $('#grp-add-teach').value;
        const cid = $('#grp-add-child').value;
        if(!gid){ showToast('–£–∫–∞–∂–∏—Ç–µ ID –≥—Ä—É–ø–ø—ã', 'warning'); return; }
        const btn = $('#grp-add-btn');
        btn.disabled = true;
        btn.classList.add('loading');
        const params = new URLSearchParams();
        params.append('id', gid);
        if(tid) params.append('teacherOrAssistantId', tid);
        if(cid) params.append('childId', cid);
        try{
          const url = apiUrl('/api/group/add-teacher-assistant-child?' + params.toString());
          if(!url) return;
          const data = await fetchJson(url, { method:'PUT' });
          showToast('–ì—Ä—É–ø–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
          fetchList();
        }catch(err){ 
          console.error(err); 
          showToast(err.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã', 'error');
        }finally{
          btn.disabled = false;
          btn.classList.remove('loading');
        }
      });
    }

    function openEdit(item){
      const modal = $('#modal'); 
      modal.classList.remove('hidden');
      $('#modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî ID ' + item.id;
      const body = $('#modalBody'); 
      body.innerHTML = '';
      const fields = s.createFields;
      const inputs = {};
      fields.forEach(fd=>{
        const label = document.createElement('label'); 
        label.className='field';
        label.innerHTML = `<span>${fd.label}</span>`;
        const input = document.createElement('input');
        input.type = fd.type || 'text';
        input.name = fd.k;
        let value = '';
        if(fd.k.includes('contact.')){
          const parts = fd.k.split('.');
          value = item.contact ? item.contact[parts[1]] ?? '' : '';
        } else if(fd.k === 'parentsId'){
          if(Array.isArray(item.parents)) value = item.parents.map(p => p.id ?? p).join(',');
          else value = (item.parentsId || '') + '';
        } else {
          value = item[fd.k] ?? item[fd.k.replace(/Id$/,'')] ?? '';
        }
        if(value === null || value === undefined) value = '';
        input.value = value;
        label.appendChild(input);
        body.appendChild(label);
        inputs[fd.k] = input;
      });
      
      let statusInput = null;
      if(s.hasStatus){
        const label = document.createElement('label'); 
        label.className='field';
        label.innerHTML = `<span>–°—Ç–∞—Ç—É—Å</span>`;
        const sel = document.createElement('select'); 
        sel.name = 'status';
        s.statusOptions.forEach(o=>{ 
          const op = document.createElement('option'); 
          op.value=o; 
          op.textContent=o; 
          if(item[s.statusName] === o) op.selected = true;
          sel.appendChild(op); 
        });
        label.appendChild(sel); 
        body.appendChild(label);
        statusInput = sel;
      }
      
      const labelDel = document.createElement('label'); 
      labelDel.className='field';
      labelDel.innerHTML = `<span>–°—Ç–∞—Ç—É—Å —É–¥–∞–ª–µ–Ω–∏—è</span>`;
      const selDel = document.createElement('select'); 
      selDel.name='delete';
      ['EXIST','DELETED'].forEach(o=>{ 
        const op=document.createElement('option'); 
        op.value=o; 
        op.textContent=o; 
        selDel.appendChild(op); 
      });
      labelDel.appendChild(selDel); 
      body.appendChild(labelDel);

      $('#modalCancel').onclick = ()=> { modal.classList.add('hidden'); body.innerHTML=''; };
      $('#modalSave').onclick = async ()=>{
        const btn = $('#modalSave');
        btn.disabled = true;
        btn.classList.add('loading');
        const formData = new FormData();
        for(const k in inputs) formData.set(k, inputs[k].value);
        if(statusInput) formData.set('status', statusInput.value);
        const deleteFlag = selDel.value;
        const bodyToSend = buildCreateBody(formData);
        const id = item.id;
        try{
          let url = apiUrl(s.path + '/update?id=' + encodeURIComponent(id) + '&delete=' + encodeURIComponent(deleteFlag));
          if(!url) return;
          if(s.hasStatus){
            const qn = s.statusName || 'status';
            url += '&' + encodeURIComponent(qn) + '=' + encodeURIComponent(formData.get('status') || '');
          }
          const data = await fetchJson(url, { method:'PUT', body: bodyToSend });
          showToast('–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
          modal.classList.add('hidden');
          fetchList();
        }catch(err){
          console.error(err);
          showToast(err.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
        }finally{
          btn.disabled = false;
          btn.classList.remove('loading');
        }
      };
    }

    async function doDelete(id){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å ID ' + id + '?')) return;
      try{
        const url = apiUrl(s.path + '/delete?id=' + encodeURIComponent(id));
        if(!url) return;
        const data = await fetchJson(url, { method:'DELETE' });
        showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
        fetchList();
      }catch(err){
        console.error(err);
        showToast(err.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
      }
    }

    fetchList();
  }

  /*******************************
   * Auth UI
   *******************************/
  function renderAuth(){
    panelContent.innerHTML = '';
    panelTitle.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è';
    $('#panelHint').textContent = '–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å';
    
    const box = document.createElement('div');
    box.className = 'grid-two';

    // left: login/register
    const left = document.createElement('div');
    const loginCard = document.createElement('div'); 
    loginCard.className='card';
    loginCard.style.marginBottom = '20px';
    loginCard.innerHTML = `
      <h3 style="margin-bottom:16px;font-size:18px">üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
      <form id="loginFormLocal" class="row">
        <label class="field"><span>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <span style="color:var(--danger)">*</span></span><input name="username" required placeholder="admin" /></label>
        <label class="field"><span>–ü–∞—Ä–æ–ª—å <span style="color:var(--danger)">*</span></span><input name="password" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></label>
        <div class="actions"><button class="btn" type="submit">–í–æ–π—Ç–∏</button><button class="btn ghost" id="logoutBtn" type="button">–í—ã–π—Ç–∏</button></div>
      </form>
    `;
    left.appendChild(loginCard);

    const regCard = document.createElement('div'); 
    regCard.className='card';
    regCard.innerHTML = `
      <h3 style="margin-bottom:16px;font-size:18px">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
      <form id="regFormLocal" class="row">
        <label class="field"><span>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <span style="color:var(--danger)">*</span></span><input name="username" required placeholder="user123" /></label>
        <label class="field"><span>–ü–∞—Ä–æ–ª—å <span style="color:var(--danger)">*</span></span><input name="password" type="password" required minlength="6" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" /></label>
        <label class="field"><span>Email <span style="color:var(--danger)">*</span></span><input name="email" type="email" required placeholder="user@example.com" /></label>
        <div class="actions"><button class="btn" type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button></div>
      </form>
      <div class="notice muted small" style="margin-top:12px">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è —Ä–æ–ª—å PARENT</div>
    `;
    left.appendChild(regCard);

    // right: forgot/reset
    const right = document.createElement('div');
    const forgotCard = document.createElement('div'); 
    forgotCard.className='card';
    forgotCard.style.marginBottom = '20px';
    forgotCard.innerHTML = `
      <h3 style="margin-bottom:16px;font-size:18px">üîë –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</h3>
      <form id="forgotFormLocal" class="row">
        <label class="field"><span>Email <span style="color:var(--danger)">*</span></span><input name="email" type="email" required placeholder="your@email.com" /></label>
        <div class="actions"><button class="btn" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</button></div>
      </form>
      <div id="resetCodeDisplay" class="code-display hidden">
        <div class="small muted">‚úÖ –ö–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</div>
        <div class="code" id="resetCodeValue"></div>
        <div class="small muted" style="margin-top:8px">‚è∞ –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 10 –º–∏–Ω—É—Ç</div>
        <div class="small muted">üìß –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –∏ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞</div>
      </div>
    `;
    
    const resetCard = document.createElement('div'); 
    resetCard.className='card';
    resetCard.innerHTML = `
      <h3 style="margin-bottom:16px;font-size:18px">üîÑ –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h3>
      <form id="resetFormLocal" class="row">
        <label class="field"><span>Email <span style="color:var(--danger)">*</span></span><input name="email" type="email" required placeholder="your@email.com" /></label>
        <label class="field"><span>–ö–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è <span style="color:var(--danger)">*</span></span><input name="code" required placeholder="123456" maxlength="6" pattern="[0-9]{6}" /></label>
        <label class="field"><span>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å <span style="color:var(--danger)">*</span></span><input name="newPassword" type="password" required minlength="6" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" /></label>
        <div class="actions"><button class="btn" type="submit">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button></div>
      </form>
    `;
    right.appendChild(forgotCard); 
    right.appendChild(resetCard);

    box.appendChild(left); 
    box.appendChild(right);
    panelContent.appendChild(box);

    // attach events
    $('#logoutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('kg_token'); 
      showUserInfo(); 
      showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
    });

    $('#loginFormLocal').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.classList.add('loading');
      submitBtn.textContent = '–í—Ö–æ–¥...';
      try{
        const url = apiUrl('/api/auth/login');
        if(!url) return;
        const data = await fetchJson(url, { method:'POST', body: { username: fd.get('username'), password: fd.get('password') }});
        if(data && data.token){ 
          localStorage.setItem('kg_token', data.token); 
          showUserInfo(); 
          showToast('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!');
          e.target.reset();
        }
        else showToast('–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'error');
      }catch(err){ 
        console.error(err); 
        const errorMsg = err.data?.message || err.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
        showToast(errorMsg, 'error');
      }finally{
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
        submitBtn.textContent = originalText;
      }
    });

    $('#regFormLocal').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const username = fd.get('username');
      const password = fd.get('password');
      const email = fd.get('email');
      if(!username || !password || !email) {
        showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'warning');
        return;
      }
      if(password.length < 6) {
        showToast('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'warning');
        return;
      }
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.classList.add('loading');
      submitBtn.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
      try{
        const url = apiUrl('/api/auth/register');
        if(!url) return;
        const data = await fetchJson(url, { method:'POST', body: { username: username, password: password, email: email }});
        showToast(data.message || '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
        e.target.reset();
      }catch(err){ 
        console.error(err); 
        const errorMsg = err.data?.message || err.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
        showToast(errorMsg, 'error');
      }finally{
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
        submitBtn.textContent = originalText;
      }
    });

    $('#forgotFormLocal').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const email = fd.get('email');
      if(!email) { 
        showToast('–í–≤–µ–¥–∏—Ç–µ email', 'warning'); 
        return; 
      }
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.classList.add('loading');
      submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
      try{
        const url = apiUrl('/api/auth/forgot-password');
        if(!url) return;
        const data = await fetchJson(url, { method:'POST', body: { email: email }});
        if(data.code) {
          const codeDisplay = $('#resetCodeDisplay');
          const codeValue = $('#resetCodeValue');
          if(codeDisplay && codeValue) {
            codeValue.textContent = data.code;
            codeDisplay.classList.remove('hidden');
            const resetCodeInput = document.querySelector('#resetFormLocal input[name="code"]');
            const resetEmailInput = document.querySelector('#resetFormLocal input[name="email"]');
            if(resetCodeInput) resetCodeInput.value = data.code;
            if(resetEmailInput) resetEmailInput.value = email;
          }
        }
        showToast(data.message || '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –∏ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞.');
        if(data.code) console.log('–ö–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è ' + email + ': ' + data.code);
      }catch(err){ 
        console.error(err); 
        const errorMsg = err.data?.message || err.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞';
        showToast(errorMsg, 'error');
        const codeDisplay = $('#resetCodeDisplay');
        if(codeDisplay) codeDisplay.classList.add('hidden');
      }finally{
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
        submitBtn.textContent = originalText;
      }
    });

    $('#resetFormLocal').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const email = fd.get('email');
      const code = fd.get('code');
      const newPassword = fd.get('newPassword');
      if(!email || !code || !newPassword) { 
        showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'warning'); 
        return; 
      }
      if(newPassword.length < 6) {
        showToast('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'warning');
        return;
      }
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.classList.add('loading');
      submitBtn.textContent = '–°–±—Ä–æ—Å...';
      try{
        const url = apiUrl('/api/auth/reset-password');
        if(!url) return;
        const data = await fetchJson(url, { 
          method:'POST', 
          body: { 
            email: email, 
            code: code, 
            newPassword: newPassword 
          }
        });
        showToast(data.message || '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ —Å –Ω–æ–≤—ã–º –ø–∞—Ä–æ–ª–µ–º.');
        e.target.reset();
        $('#resetCodeDisplay').classList.add('hidden');
      }catch(err){ 
        console.error(err); 
        const errorMsg = err.data?.message || err.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø–∞—Ä–æ–ª—è';
        showToast(errorMsg + '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n‚Ä¢ –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å email\n‚Ä¢ –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞\n‚Ä¢ –ö–æ–¥ –Ω–µ –∏—Å—Ç—ë–∫ (10 –º–∏–Ω—É—Ç)', 'error');
      }finally{
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
        submitBtn.textContent = originalText;
      }
    });
  }

  /*******************************
   * Menu wiring
   *******************************/
  function switchTo(key){
    $$('#menu button').forEach(b => b.classList.toggle('active', b.dataset.key === key));
    if(key === 'auth') renderAuth();
    else renderEntity(key);
  }
  $$('#menu button').forEach(b => b.addEventListener('click', ()=> switchTo(b.dataset.key)));
  $('#btnShowAuth').addEventListener('click', ()=> switchTo('auth'));

  // initial
  showUserInfo();
  renderAuth();

  // modal close on backdrop click
  $('#modal').addEventListener('click', (ev)=> { 
    if(ev.target === $('#modal')) $('#modal').classList.add('hidden'); 
  });

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º API base –≤ localStorage
  const apiBaseInput = $('#apiBase');
  const savedApiBase = localStorage.getItem('apiBase');
  if(savedApiBase) apiBaseInput.value = savedApiBase;
  
  apiBaseInput.addEventListener('change', () => {
    localStorage.setItem('apiBase', apiBaseInput.value);
  });
  
  apiBaseInput.addEventListener('keypress', (e) => {
    if(e.key === 'Enter') {
      testConnection();
    }
  });

  // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  const testBtn = $('#testConnectionBtn');
  if(testBtn) {
    testBtn.addEventListener('click', testConnection);
  }

  </script>
</body>
</html>
