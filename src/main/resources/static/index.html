<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kindergarten Admin — Single File Frontend</title>
  <style>
    /* Modern, clean admin look */
    :root{
      --bg:#0f1724; --surface:#0b1220; --muted:#9aa4b2; --accent:#7c3aed; --glass: rgba(255,255,255,0.03);
      --card-bg: #0b1220; --card-2: #071733; --success: #16a34a; --danger:#ef4444;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071127 0%, #071733 60%);color:#e6eef8}
    .wrap{max-width:1200px;margin:28px auto;padding:20px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 8px 30px rgba(2,6,23,0.7)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{margin:0;font-size:20px}
    .controls{display:flex;gap:8px;align-items:center}
    .token{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.03);font-size:13px}
    .btn{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:white;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .layout{display:grid;grid-template-columns:260px 1fr;gap:18px;margin-top:18px}
    nav.card, section.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px}
    nav .menu{display:flex;flex-direction:column;gap:8px}
    nav .menu button{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:10px;border-radius:8px;text-align:left;cursor:pointer}
    nav .menu button.active{border-color:var(--accent);color:white;box-shadow:0 4px 20px rgba(124,58,237,0.15)}
    section.card{min-height:380px}
    .grid-two{display:grid;grid-template-columns:1fr 360px;gap:16px}
    form.row{display:flex;flex-wrap:wrap;gap:10px}
    label.field{display:flex;flex-direction:column;font-size:13px;color:var(--muted)}
    input, select, textarea{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:inherit;min-width:160px}
    .actions{display:flex;gap:8px;align-items:center}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px;text-align:left}
    .muted{color:var(--muted);font-size:13px}
    .notice{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;color:var(--muted)}
    .danger{background:linear-gradient(90deg,#8b1e1e,#ef4444)}
    footer{margin-top:12px;color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03)}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:50}
    .modal .box{background:var(--card-bg);padding:18px;border-radius:10px;width:720px;max-width:95%}
    .hidden{display:none}
    @media(max-width:900px){.layout{grid-template-columns:1fr}.grid-two{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Kindergarten Admin Panel</h1>
        <div class="small muted">Frontend (single file). Укажи API Base — например <code>http://localhost:8080</code></div>
      </div>
      <div class="controls">
        <input id="apiBase" placeholder="API base (http://localhost:8080)" value="http://localhost:8080" style="padding:8px;border-radius:8px;border:none"/>
        <div class="token" id="userInfo">Не авторизован</div>
        <button class="btn ghost" id="btnShowAuth">Auth</button>
      </div>
    </header>

    <div class="layout">
      <nav class="card">
        <div class="menu" id="menu">
          <button data-key="auth" class="active">Auth</button>
          <button data-key="age-group">Age Groups</button>
          <button data-key="group">Groups</button>
          <button data-key="child">Children</button>
          <button data-key="parent">Parents</button>
          <button data-key="teacher">Teachers</button>
          <button data-key="payment">Payments</button>
          <button data-key="child-group-history">Child Group History</button>
        </div>
      </nav>

      <main>
        <section class="card" id="panel">
          <div class="section-header">
            <div class="flex">
              <h2 id="panelTitle">Auth</h2>
              <div class="small muted" style="margin-left:12px" id="panelHint">Войдите, чтобы получить JWT</div>
            </div>
            <div class="right small muted">Token stored to localStorage <code>kg_token</code></div>
          </div>

          <div id="panelContent" style="margin-top:12px">
            <!-- Dynamic content -->
          </div>

          <footer style="margin-top:12px">
            <div class="muted small">Один файл. JWT используется в заголовке Authorization: Bearer &lt;token&gt;.</div>
          </footer>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal (used for edit) -->
  <div id="modal" class="modal hidden">
    <div class="box">
      <h3 id="modalTitle">Edit</h3>
      <div id="modalBody"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn ghost" id="modalCancel">Отмена</button>
        <button class="btn" id="modalSave">Сохранить</button>
      </div>
    </div>
  </div>

  <script>
  /*******************************
   * Helper utils
   *******************************/
  const $ = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

  function apiUrl(path){
    const base = (document.getElementById('apiBase').value || '').replace(/\/$/, '');
    if(!path.startsWith('/')) path = '/' + path;
    return base + path;
  }

  function authHeader(){
    const t = localStorage.getItem('kg_token');
    return t ? { 'Authorization': 'Bearer ' + t } : {};
  }

  async function fetchJson(url, opts = {}){
    opts.headers = { ...(opts.headers||{}), 'Accept': 'application/json', ...authHeader() };
    if(opts.body && typeof opts.body === 'object' && !(opts.body instanceof FormData)) {
      opts.headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify(opts.body);
    }
    const res = await fetch(url, opts);
    const text = await res.text().catch(()=>'');
    let data = null;
    try{ data = text ? JSON.parse(text) : null }catch(e){ data = text }
    if(!res.ok) throw { status: res.status, data };
    return data;
  }

  function showUserInfo(){
    const el = $('#userInfo');
    const t = localStorage.getItem('kg_token');
    if(t) el.textContent = 'Авторизован (token present)';
    else el.textContent = 'Не авторизован';
  }

  function showNotice(msg, isError=false){
    // simple alert for now; could render inside panel
    if(isError) alert('Ошибка: ' + msg);
    else { /* small toast */ console.log(msg); }
  }

  /*******************************
   * UI templates for entities
   *******************************/
  const entitySchemas = {
    'auth': { name: 'Auth' },
    'age-group': {
      name: 'Age groups',
      path: '/api/age-group',
      createFields: [
        {k:'name', label:'Название', type:'text', required:true},
        {k:'ageGroup', label:'Возраст (1-7)', type:'number', min:1, max:7, required:true},
        {k:'price', label:'Цена', type:'number', step:'0.01', required:true}
      ],
      hasStatus:false
    },
    'group': {
      name:'Groups',
      path:'/api/group',
      createFields:[
        {k:'name',label:'Название',type:'text',required:true},
        {k:'ageGroupId',label:'AgeGroup ID',type:'number',required:true}
      ],
      special:{
        addTeacherAssistantChild: apiUrl.bind(null, '/api/group/add-teacher-assistant-child')
      }
    },
    'child': {
      name:'Children',
      path:'/api/child',
      createFields:[
        {k:'firstName',label:'Имя',type:'text',required:true},
        {k:'lastName',label:'Фамилия',type:'text',required:true},
        {k:'patronymic',label:'Отчество',type:'text'},
        {k:'dateOfBirth',label:'Дата рождения',type:'date',required:true},
        {k:'group',label:'Group ID',type:'number'},
        {k:'parentsId',label:'Parents IDs (comma sep)',type:'text'}
      ]
    },
    'parent': {
      name:'Parents',
      path:'/api/parent',
      createFields:[
        {k:'firstName',label:'Имя',type:'text',required:true},
        {k:'lastName',label:'Фамилия',type:'text',required:true},
        {k:'patronymic',label:'Отчество',type:'text'},
        // contactCreate nested object
        {k:'contact.phoneNumber',label:'Phone (+996XXXXXXXXX)',type:'text',required:true},
        {k:'contact.secondaryPhoneNumber',label:'Secondary phone',type:'text'},
        {k:'contact.email',label:'Contact email',type:'email',required:true}
      ],
      hasStatus:true,
      statusName:'role',
      statusOptions:['FATHER','MOTHER','OTHER','PARENT','ADMIN','TEACHER'] // possible values; backend enum may differ
    },
    'teacher': {
      name:'Teachers',
      path:'/api/teacher',
      createFields:[
        {k:'firstName',label:'Имя',type:'text',required:true},
        {k:'lastName',label:'Фамилия',type:'text',required:true},
        {k:'patronymic',label:'Отчество',type:'text'},
        {k:'dateOfBirth',label:'Дата рождения',type:'date',required:true},
        {k:'contact.phoneNumber',label:'Phone (+996XXXXXXXXX)',type:'text',required:true},
        {k:'contact.secondaryPhoneNumber',label:'Secondary phone',type:'text'},
        {k:'contact.email',label:'Contact email',type:'email',required:true}
      ],
      hasStatus:true,
      statusName:'position',
      statusOptions:['TEACHER','ASSISTANT','OTHER']
    },
    'payment': {
      name:'Payments',
      path:'/api/payment',
      createFields:[
        {k:'childId',label:'Child ID',type:'number',required:true},
        {k:'paymentSum',label:'Сумма',type:'number',step:'0.01',required:true},
        {k:'period',label:'Период MM.yyyy',type:'text',required:true}
      ],
      hasStatus:true,
      statusName:'paymentType',
      statusOptions:['MONTHLY','ONE_TIME']
    },
    'child-group-history': {
      name:'Child Group History',
      path:'/api/child-group-history',
      createFields:[
        {k:'groupId',label:'Group ID',type:'number',required:true},
        {k:'childId',label:'Child ID',type:'number',required:true},
        // DTO for save only requires groupId, childId
      ]
    }
  };

  /*******************************
   * Render panel content for entity
   *******************************/
  const panelContent = $('#panelContent');
  const panelTitle = $('#panelTitle');

  async function renderEntity(key){
    panelContent.innerHTML = '';
    panelTitle.textContent = entitySchemas[key].name || key;

    if(key === 'auth'){ renderAuth(); return; }

    const s = entitySchemas[key];
    const card = document.createElement('div');
    card.className = 'grid-two';

    // LEFT: create form + special actions
    const left = document.createElement('div');
    left.innerHTML = `<div class="notice muted small">Endpoint: <code>${s.path}</code></div>`;
    const createBox = document.createElement('div');
    createBox.className = 'card';
    const f = document.createElement('form');
    f.className = 'row';
    f.id = key + '-create-form';

    s.createFields.forEach(fd=>{
      const label = document.createElement('label'); label.className='field';
      label.innerHTML = `<span class="small muted">${fd.label}${fd.required? ' *':''}</span>`;
      const input = document.createElement('input');
      input.name = fd.k;
      input.type = fd.type || 'text';
      if(fd.min !== undefined) input.min = fd.min;
      if(fd.max !== undefined) input.max = fd.max;
      if(fd.step) input.step = fd.step;
      if(fd.required) input.required = true;
      label.appendChild(input);
      f.appendChild(label);
    });
    // status selector if needed
    if(s.hasStatus){
      const label = document.createElement('label'); label.className='field';
      label.innerHTML = `<span class="small muted">Status</span>`;
      const sel = document.createElement('select'); sel.name = 'status';
      s.statusOptions.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; sel.appendChild(op); });
      label.appendChild(sel);
      f.appendChild(label);
    }
    const submit = document.createElement('button'); submit.className='btn'; submit.textContent='Create';
    f.appendChild(submit);
    createBox.appendChild(f);
    left.appendChild(createBox);

    // list + controls
    const listBox = document.createElement('div'); listBox.className='card';
    const controlRow = document.createElement('div'); controlRow.className='flex';
    controlRow.innerHTML = `<input id="${key}-query-id" placeholder="ID для поиска" style="padding:8px;border-radius:8px;border:none"/><button id="${key}-find" class="btn ghost">Find by ID</button>
      <div style="margin-left:auto" class="flex"><input id="${key}-page" type="number" value="0" style="width:80px;padding:8px;border-radius:8px;border:none"/><input id="${key}-size" type="number" value="20" style="width:80px;padding:8px;border-radius:8px;border:none"/><button id="${key}-list" class="btn">Get list</button></div>`;
    listBox.appendChild(controlRow);
    const tableWrap = document.createElement('div'); tableWrap.id = key + '-table';
    listBox.appendChild(tableWrap);
    left.appendChild(listBox);

    // RIGHT: helper / docs / special operations
    const right = document.createElement('div');
    right.className = 'card';
    right.innerHTML = `<div class="muted small">Инструкции:</div>
      <ul class="small muted">
        <li>Create — POST ${s.path}/create${s.hasStatus? '?status=...':''}</li>
        <li>Update — PUT ${s.path}/update?id=&${s.hasStatus? 'status=&':''}delete=EXIST|DELETED</li>
        <li>Delete — DELETE ${s.path}/delete?id=</li>
        <li>List — GET ${s.path}/get-list?page=&size=</li>
        <li>Find — GET ${s.path}/find-by-id?id=</li>
      </ul>
    `;
    // special group helper
    if(key === 'group'){
      const h = document.createElement('div'); h.style.marginTop='8px';
      h.innerHTML = `<div class="small muted">Special: add teacher/assistant/child to group</div>
        <div class="row" style="margin-top:6px">
          <input id="grp-add-id" placeholder="group id" style="padding:8px;border-radius:8px;border:none"/>
          <input id="grp-add-teach" placeholder="teacher/assistant id (optional)" style="padding:8px;border-radius:8px;border:none"/>
          <input id="grp-add-child" placeholder="child id (optional)" style="padding:8px;border-radius:8px;border:none"/>
          <button id="grp-add-btn" class="btn">Add</button>
        </div>`;
      right.appendChild(h);
    }

    card.appendChild(left);
    card.appendChild(right);
    panelContent.appendChild(card);

    // functions for list / find / create / edit / delete
    async function fetchList(){
      const page = $('#'+key+'-page').value || 0;
      const size = $('#'+key+'-size').value || 20;
      try{
        const url = apiUrl((s.path || '/') + '/get-list?page=' + page + '&size=' + size);
        const data = await fetchJson(url, { method:'GET' });
        renderTable(data);
      }catch(err){
        console.error(err);
        showNotice(err.data?.message || err.message || JSON.stringify(err), true);
      }
    }

    async function findById(){
      const id = $('#'+key+'-query-id').value;
      if(!id){ alert('Укажи ID'); return; }
      try{
        const url = apiUrl((s.path || '/') + '/find-by-id?id=' + id);
        const data = await fetchJson(url, { method:'GET' });
        renderTable([data]);
      }catch(err){ console.error(err); alert(err.data?.message || err.message || JSON.stringify(err)); }
    }

    function renderTable(items){
      const wrap = $('#'+key+'-table');
      wrap.innerHTML = '';
      if(!items || items.length === 0){ wrap.innerHTML = '<div class="muted small">Пусто</div>'; return; }
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      // gather columns from first item (and union)
      const cols = new Set();
      items.forEach(it => Object.keys(it || {}).forEach(k => cols.add(k)));
      const colArr = Array.from(cols);
      colArr.forEach(c=>{ const th = document.createElement('th'); th.textContent = c; headerRow.appendChild(th); });
      headerRow.appendChild(document.createElement('th'));
      thead.appendChild(headerRow);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      items.forEach(item=>{
        const tr = document.createElement('tr');
        colArr.forEach(c=>{
          const td = document.createElement('td');
          let v = item[c];
          if(v === null || v === undefined) td.textContent = '';
          else if(typeof v === 'object') {
            // display short object summary
            try{ td.textContent = JSON.stringify(v); }catch(e){ td.textContent = String(v); }
          } else td.textContent = v;
          tr.appendChild(td);
        });
        const tdA = document.createElement('td');
        const btnEdit = document.createElement('button'); btnEdit.className='btn ghost'; btnEdit.textContent='Edit';
        const btnDelete = document.createElement('button'); btnDelete.className='btn ghost'; btnDelete.textContent='Delete';
        btnEdit.addEventListener('click', ()=> openEdit(item));
        btnDelete.addEventListener('click', ()=> doDelete(item.id));
        tdA.appendChild(btnEdit); tdA.appendChild(btnDelete);
        tr.appendChild(tdA);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      wrap.appendChild(table);
    }

    function buildCreateBody(formData){
      // construct nested objects for dotted keys, arrays for parentsId CSV etc.
      const body = {};
      for(const [k,v] of new FormData(formData).entries()){
        if(k === 'status') continue; // status goes to query param
        if(k.includes('contact.')){
          const parts = k.split('.');
          body['contactCreate'] = body['contactCreate'] || {};
          body['contactCreate'][parts[1]] = v;
        } else if(k === 'parentsId'){
          const arr = v ? v.split(',').map(x=>{ const n = Number(x.trim()); return isNaN(n)? null : n; }).filter(x=>x!==null) : [];
          body['parentsId'] = arr;
        } else if(k === 'group' || k === 'groupId' || k === 'ageGroupId'){
          // some DTOs expect field names group or ageGroupId
          // keep numeric
          const num = Number(v); if(!isNaN(num)) body[k] = num; else body[k] = v;
        } else if(k === 'dateOfBirth'){
          // DTO expects LocalDate string "yyyy-mm-dd"
          body[k] = v;
        } else if(k === 'paymentDate'){
          // optionally allow datetime-local -> format
          body[k] = v;
        } else if(k === 'childId' || k==='childId' || k==='paymentSum' || k==='ageGroup' || k==='price' || k==='childId'){
          const num = Number(v); body[k] = isNaN(num) ? v : num;
        } else {
          body[k] = v;
        }
      }
      return body;
    }

    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const status = f.querySelector('[name="status"]') ? f.querySelector('[name="status"]').value : null;
      const body = buildCreateBody(f);
      try{
        let url = apiUrl(s.path + '/create');
        if(status) url += '?'+encodeURIComponent(s.statusName || 'status')+'='+encodeURIComponent(status);
        const data = await fetchJson(url, { method:'POST', body });
        alert('Created: ' + (data?.id || 'OK'));
        fetchList();
      }catch(err){
        console.error(err);
        alert(err.data?.message || err.message || JSON.stringify(err));
      }
    });

    $('#'+key+'-list').addEventListener('click', fetchList);
    $('#'+key+'-find').addEventListener('click', findById);

    // group special
    if(key === 'group'){
      $('#grp-add-btn').addEventListener('click', async ()=>{
        const gid = $('#grp-add-id').value;
        const tid = $('#grp-add-teach').value;
        const cid = $('#grp-add-child').value;
        if(!gid){ alert('Укажи group id'); return; }
        const params = new URLSearchParams();
        params.append('id', gid);
        if(tid) params.append('teacherOrAssistantId', tid);
        if(cid) params.append('childId', cid);
        try{
          const url = apiUrl('/api/group/add-teacher-assistant-child?' + params.toString());
          const data = await fetchJson(url, { method:'PUT' });
          alert('Group updated');
          fetchList();
        }catch(err){ console.error(err); alert(err.data?.message || err.message || JSON.stringify(err)); }
      });
    }

    // open edit dialog -> use same DTO shape as create; send PUT to /update?id=..&status=..&delete=
    function openEdit(item){
      // build modal contents: inputs for editable fields
      const modal = $('#modal'); modal.classList.remove('hidden');
      $('#modalTitle').textContent = 'Edit — id ' + item.id;
      const body = $('#modalBody'); body.innerHTML = '';
      const fields = s.createFields;
      const inputs = {};
      fields.forEach(fd=>{
        const label = document.createElement('label'); label.className='field';
        label.innerHTML = `<span class="small muted">${fd.label}</span>`;
        const input = document.createElement('input');
        input.type = fd.type || 'text';
        input.name = fd.k;
        // set value from item (support nested contact or children)
        let value = '';
        if(fd.k.includes('contact.')){
          const parts = fd.k.split('.');
          value = item.contact ? item.contact[parts[1]] ?? '' : '';
        } else if(fd.k === 'parentsId'){
          // show as comma separated numbers
          if(Array.isArray(item.parents)) value = item.parents.map(p => p.id ?? p).join(',');
          else value = (item.parentsId || '') + '';
        } else {
          value = item[fd.k] ?? item[fd.k.replace(/Id$/,'')] ?? '';
        }
        if(value === null || value === undefined) value = '';
        input.value = value;
        label.appendChild(input);
        body.appendChild(label);
        inputs[fd.k] = input;
      });
      // status if applicable
      let statusInput = null;
      if(s.hasStatus){
        const label = document.createElement('label'); label.className='field';
        label.innerHTML = `<span class="small muted">Status</span>`;
        const sel = document.createElement('select'); sel.name = 'status';
        s.statusOptions.forEach(o=>{ const op = document.createElement('option'); op.value=o; op.textContent=o; sel.appendChild(op); });
        label.appendChild(sel); body.appendChild(label);
        statusInput = sel;
      }
      // delete select
      const labelDel = document.createElement('label'); labelDel.className='field';
      labelDel.innerHTML = `<span class="small muted">Delete flag</span>`;
      const selDel = document.createElement('select'); selDel.name='delete';
      ['EXIST','DELETED'].forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; selDel.appendChild(op); });
      labelDel.appendChild(selDel); body.appendChild(labelDel);

      // handlers
      $('#modalCancel').onclick = ()=> { modal.classList.add('hidden'); body.innerHTML=''; };
      $('#modalSave').onclick = async ()=>{
        // collect body similar to create
        const formData = new FormData();
        for(const k in inputs) formData.set(k, inputs[k].value);
        if(statusInput) formData.set('status', statusInput.value);
        const deleteFlag = selDel.value;
        const bodyToSend = buildCreateBody(formData);
        const id = item.id;
        try{
          let url = apiUrl(s.path + '/update?id=' + encodeURIComponent(id) + '&delete=' + encodeURIComponent(deleteFlag));
          if(s.hasStatus){
            const qn = s.statusName || 'status';
            url += '&' + encodeURIComponent(qn) + '=' + encodeURIComponent(formData.get('status') || '');
          }
          const data = await fetchJson(url, { method:'PUT', body: bodyToSend });
          alert('Updated');
          modal.classList.add('hidden');
          fetchList();
        }catch(err){
          console.error(err);
          alert(err.data?.message || err.message || JSON.stringify(err));
        }
      };
    }

    async function doDelete(id){
      if(!confirm('Удалить запись ID ' + id + ' ?')) return;
      try{
        const url = apiUrl(s.path + '/delete?id=' + encodeURIComponent(id));
        const data = await fetchJson(url, { method:'DELETE' });
        alert('Deleted');
        fetchList();
      }catch(err){
        console.error(err);
        alert(err.data?.message || err.message || JSON.stringify(err));
      }
    }

    // initial list load
    fetchList();
  }

  /*******************************
   * Auth UI (custom)
   *******************************/
  function renderAuth(){
    panelContent.innerHTML = '';
    const box = document.createElement('div');
    box.className = 'grid-two';

    // left: login/register
    const left = document.createElement('div');
    const loginCard = document.createElement('div'); loginCard.className='card';
    loginCard.innerHTML = `<h3>Login</h3>
      <form id="loginFormLocal" class="row">
        <label class="field"><span class="small muted">Username</span><input name="username" required /></label>
        <label class="field"><span class="small muted">Password</span><input name="password" type="password" required /></label>
        <div class="actions"><button class="btn" type="submit">Login</button><button class="btn ghost" id="logoutBtn" type="button">Logout</button></div>
      </form>`;
    left.appendChild(loginCard);

    const regCard = document.createElement('div'); regCard.className='card';
    regCard.innerHTML = `<h3>Register</h3>
      <form id="regFormLocal" class="row">
        <label class="field"><span class="small muted">Username</span><input name="username" required /></label>
        <label class="field"><span class="small muted">Password</span><input name="password" type="password" required /></label>
        <label class="field"><span class="small muted">Email</span><input name="email" type="email" required /></label>
        <div class="actions"><button class="btn" type="submit">Register</button></div>
      </form>
      <div class="muted small" style="margin-top:8px">По умолчанию роль PARENT на бекенде.</div>`;
    left.appendChild(regCard);

    // right: forgot/reset
    const right = document.createElement('div');
    const forgotCard = document.createElement('div'); forgotCard.className='card';
    forgotCard.innerHTML = `<h3>Forgot Password</h3>
      <form id="forgotFormLocal" class="row">
        <label class="field"><span class="small muted">Email</span><input name="email" type="email" required /></label>
        <div class="actions"><button class="btn" type="submit">Send code</button></div>
      </form>`;
    const resetCard = document.createElement('div'); resetCard.className='card';
    resetCard.innerHTML = `<h3>Reset Password</h3>
      <form id="resetFormLocal" class="row">
        <label class="field"><span class="small muted">Email</span><input name="email" type="email" required /></label>
        <label class="field"><span class="small muted">Code</span><input name="code" required /></label>
        <label class="field"><span class="small muted">New password</span><input name="newPassword" type="password" required /></label>
        <div class="actions"><button class="btn" type="submit">Reset</button></div>
      </form>`;
    right.appendChild(forgotCard); right.appendChild(resetCard);

    box.appendChild(left); box.appendChild(right);
    panelContent.appendChild(box);

    // attach events
    $('#logoutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('kg_token'); showUserInfo(); alert('Logged out');
    });

    $('#loginFormLocal').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      try{
        const data = await fetchJson(apiUrl('/api/auth/login'), { method:'POST', body: { username: fd.get('username'), password: fd.get('password') }});
        if(data && data.token){ localStorage.setItem('kg_token', data.token); showUserInfo(); alert('Успешный вход'); }
        else alert('Ответ: ' + JSON.stringify(data));
      }catch(err){ console.error(err); alert(err.data?.message || err.message || JSON.stringify(err)); }
    });

    $('#regFormLocal').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      try{
        const data = await fetchJson(apiUrl('/api/auth/register'), { method:'POST', body: { username: fd.get('username'), password: fd.get('password'), email: fd.get('email') }});
        alert(data.message || 'Registered');
      }catch(err){ console.error(err); alert(err.data?.message || err.message || JSON.stringify(err)); }
    });

    $('#forgotFormLocal').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      try{
        const data = await fetchJson(apiUrl('/api/auth/forgot-password'), { method:'POST', body: { email: fd.get('email') }});
        alert(data.message + (data.code ? '\\nCode: ' + data.code : ''));
      }catch(err){ console.error(err); alert(err.data?.message || err.message || JSON.stringify(err)); }
    });

    $('#resetFormLocal').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      try{
        const data = await fetchJson(apiUrl('/api/auth/reset-password'), { method:'POST', body: { email: fd.get('email'), code: fd.get('code'), newPassword: fd.get('newPassword') }});
        alert(data.message || 'Password reset');
      }catch(err){ console.error(err); alert(err.data?.message || err.message || JSON.stringify(err)); }
    });
  }

  /*******************************
   * Menu wiring
   *******************************/
  function switchTo(key){
    // set active
    $$('#menu button').forEach(b => b.classList.toggle('active', b.dataset.key === key));
    if(key === 'auth') renderAuth();
    else renderEntity(key);
  }
  $$('#menu button').forEach(b => b.addEventListener('click', ()=> switchTo(b.dataset.key)));
  $('#btnShowAuth').addEventListener('click', ()=> switchTo('auth'));

  // initial
  showUserInfo();
  renderAuth();

  // modal close on backdrop click
  $('#modal').addEventListener('click', (ev)=> { if(ev.target === $('#modal')) $('#modal').classList.add('hidden'); });

  </script>
</body>
</html>
